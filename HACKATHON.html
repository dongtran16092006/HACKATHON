<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kh√°m ph√° ƒë·ªãa ƒëi·ªÉm g·∫ßn b·∫°n</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    * { box-sizing: border-box; }

    body, #question-box, #profile-box, #location-info, #map,
    .choices__inner, .choices__list--dropdown, button,
    ul#places-list li, a {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, filter 0.2s ease;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: #f0f0f0;
      animation: lightPulse 10s ease-in-out infinite;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    body.dark-mode {
      background: #1a1a1a;
      animation: darkPulse 10s ease-in-out infinite;
      color: white;
    }

    body.transitioning {
      filter: blur(3px);
    }

    @keyframes lightPulse {
      0%   { background-color: #f0f0f0; }
      50%  { background-color: #e0e0e0; }
      100% { background-color: #f0f0f0; }
    }

    @keyframes darkPulse {
      0%   { background-color: #1a1a1a; }
      50%  { background-color: #2c2c2c; }
      100% { background-color: #1a1a1a; }
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #darkmode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10001;
      padding: 8px 12px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
    }

    #question-box, #profile-box, #location-info, #map {
      width: 100%;
      max-width: 600px;
      margin-bottom: 20px;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      padding: 20px;
      animation: fadeInUp 0.6s ease;
    }

    body.dark-mode #question-box,
    body.dark-mode #profile-box,
    body.dark-mode #location-info,
    body.dark-mode #map {
      background: #2c2c2c;
      color: white;
    }

    #map { height: 400px; border-radius: 16px; overflow: hidden; }

    .choices {
      width: 100% !important;
      z-index: 10;
      position: relative;
    }

    .choices__inner {
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 10px !important;
      min-height: 42px;
      background: white;
      color: black;
    }

    body.dark-mode .choices__inner {
      background: #444;
      color: white;
      border-color: #777;
    }

    .choices__list--dropdown, .choices__list[aria-expanded] {
      width: 100% !important;
      left: 0 !important;
      top: 100% !important;
      position: absolute !important;
      border-radius: 10px !important;
      font-size: 14px;
      padding: 5px 0;
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      z-index: 10000 !important;
      max-height: 200px;
      overflow-y: auto;
      color: black;
    }

    .choices__list--dropdown .choices__item {
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .choices__list--dropdown .choices__item:hover {
      background-color: #f0f0f0;
    }

    body.dark-mode .choices__list--dropdown {
      background: #333;
      color: white;
      border: 1px solid #555;
    }

    body.dark-mode .choices__list--dropdown .choices__item {
      color: white;
    }

    body.dark-mode .choices__list--dropdown .choices__item:hover {
      background-color: #555;
    }

    body.dark-mode .choices__item--selectable.is-highlighted {
      background-color: #555 !important;
      color: white !important;
    }

    body.dark-mode .choices__item--selectable[data-value][aria-selected="true"] {
      background-color: #444 !important;
      color: white !important;
    }

    button {
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 15px;
      margin-top: 12px;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      background-color: #007bff;
      color: white;
    }

    body.dark-mode button {
      background: #444;
      color: white;
      border: 1px solid #666;
    }

    body.dark-mode button:hover {
      background-color: #0056b3;
    }

    #back-button {
      background: #f44336;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 15px;
      border-radius: 12px;
      cursor: pointer;
    }

    body.dark-mode #back-button {
      background: #aa2e25;
    }

    body.dark-mode #back-button:hover {
      background: #c0392b;
    }

    ul#places-list li {
      background: #f5faff;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
    }

    body.dark-mode ul#places-list li {
      background: #3a3a3a;
    }

    a {
      color: #007bff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    body.dark-mode a {
      color: #66bfff;
    }

    body.dark-mode a:hover {
      color: #99ccff;
    }

    /* ‚úÖ Dark mode: h·ªôp ch·ªâ ƒë∆∞·ªùng */
    body.dark-mode .leaflet-routing-container {
      background-color: #2c2c2c !important;
      color: #ffffff !important;
      border: 1px solid #555 !important;
      border-radius: 12px !important;
    }

    body.dark-mode .leaflet-routing-container a {
      color: #90caf9 !important;
    }

    body.dark-mode .leaflet-routing-alt,
    body.dark-mode .leaflet-routing-alt h2,
    body.dark-mode .leaflet-routing-alt h3,
    body.dark-mode .leaflet-routing-alt span {
      background-color: transparent !important;
      color: #ddd !important;
    }

    body.dark-mode .leaflet-routing-container .leaflet-routing-icon {
      filter: invert(1);
    }

    /* ‚úÖ Hover r√µ h∆°n trong dark mode */
    body.dark-mode .leaflet-routing-container li:hover,
    body.dark-mode .leaflet-routing-container tr:hover {
      background-color: #3c3c3c !important;
      color: #ffffff !important;
    }

    body.dark-mode .leaflet-routing-container .leaflet-routing-instruction:hover {
      background-color: #444 !important;
      color: #fff !important;
    }
  </style>
</head>
<body>
  <button id="darkmode-toggle" onclick="toggleDarkMode()">üåô</button>

  <div id="question-box">
    <h2>B·∫°n mu·ªën tham quan lo·∫°i ƒë·ªãa ƒëi·ªÉm n√†o?</h2>
    <select id="category">
      <option value="culture">VƒÉn h√≥a</option>
      <option value="history">L·ªãch s·ª≠</option>
      <option value="art">Ngh·ªá thu·∫≠t</option>
    </select>
    <button onclick="startExperience()">Kh√°m ph√° ngay</button>
  </div>

  <div id="profile-box" style="display:none;">
    <h3>Th√¥ng tin ng∆∞·ªùi d√πng</h3>
    <p>Email: example@example.com</p>
  </div>

  <div id="location-info" style="display:none;">
    <h3>G·ª£i √Ω ƒë·ªãa ƒëi·ªÉm:</h3>
    <p id="status">ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...</p>
    <ul id="places-list"></ul>
    <button id="back-button" onclick="goBack()">Quay l·∫°i</button>
  </div>

  <div id="map" style="display:none;"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

  <script>
    const statusElement = document.getElementById('status');
    const placesListElement = document.getElementById('places-list');
    const categorySelectElement = document.getElementById('category');
    const profileBoxElement = document.getElementById('profile-box');
    const locationInfoElement = document.getElementById('location-info');
    const questionBoxElement = document.getElementById('question-box');
    const mapDivElement = document.getElementById('map');

    let map;
    let userLatitude, userLongitude;
    let routingControl;

    new Choices('#category', {
      searchEnabled: false,
      itemSelectText: '',
      shouldSort: false
    });

    const culturalSites = {
      culture: [
        { name: "B·∫£o t√†ng Ch·ª©ng t√≠ch Chi·∫øn tranh", lat: 10.7798, lng: 106.6926 },
        { name: "Nh√† h√°t Th√†nh ph·ªë", lat: 10.7769, lng: 106.7032 }
      ],
      history: [
        { name: "Dinh ƒê·ªôc L·∫≠p", lat: 10.7772, lng: 106.6958 },
        { name: "B·∫£o t√†ng H·ªì Ch√≠ Minh", lat: 10.7875, lng: 106.7032 }
      ],
      art: [
        { name: "B·∫£o t√†ng M·ªπ thu·∫≠t TP.HCM", lat: 10.7715, lng: 106.7001 },
        { name: "Artinus 3D Art Museum", lat: 10.7402, lng: 106.7051 }
      ]
    };

    function startExperience() {
      questionBoxElement.style.display = 'none';
      profileBoxElement.style.display = 'block';
      locationInfoElement.style.display = 'block';
      mapDivElement.style.display = 'block';

      const selectedCategory = categorySelectElement.value;
      const selectedSites = culturalSites[selectedCategory] || [];

      if (!navigator.geolocation) {
        statusElement.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.";
        return;
      }

      statusElement.textContent = "ƒêang l·∫•y v·ªã tr√≠ th·ª±c t·∫ø...";

      navigator.geolocation.getCurrentPosition(
        position => {
          userLatitude = position.coords.latitude;
          userLongitude = position.coords.longitude;

          statusElement.textContent = `V·ªã tr√≠ c·ªßa b·∫°n: (${userLatitude.toFixed(4)}, ${userLongitude.toFixed(4)})`;

          placesListElement.innerHTML = selectedSites.map(site =>
            `<li>
              <strong>${site.name}</strong> - 
              <a target="_blank" href="https://maps.google.com/?q=${site.lat},${site.lng}">Xem b·∫£n ƒë·ªì</a><br>
              <button onclick="showRoute(${site.lat}, ${site.lng})">Ch·ªâ ƒë∆∞·ªùng</button>
            </li>`
          ).join('');

          if (map) {
            map.eachLayer(layer => map.removeLayer(layer));
            map.remove();
            map = null;
          }

          map = L.map('map').setView([userLatitude, userLongitude], 14);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          L.marker([userLatitude, userLongitude]).addTo(map).bindPopup('V·ªã tr√≠ c·ªßa b·∫°n').openPopup();

          selectedSites.forEach(site => {
            L.marker([site.lat, site.lng]).addTo(map)
              .bindPopup(`<strong>${site.name}</strong>`);
          });
        },
        error => {
          statusElement.textContent = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng b·∫≠t ƒë·ªãnh v·ªã ho·∫∑c cho ph√©p tr√¨nh duy·ªát truy c·∫≠p v·ªã tr√≠.";
          console.error("L·ªói ƒë·ªãnh v·ªã:", error);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    function showRoute(destinationLatitude, destinationLongitude) {
      if (!map || !userLatitude || !userLongitude) return;

      if (routingControl) {
        map.removeControl(routingControl);
      }

      routingControl = L.Routing.control({
        waypoints: [
          L.latLng(userLatitude, userLongitude),
          L.latLng(destinationLatitude, destinationLongitude)
        ],
        routeWhileDragging: false,
        showAlternatives: false,
        createMarker: function() { return null; }
      }).addTo(map);
    }

    function goBack() {
      questionBoxElement.style.display = 'block';
      profileBoxElement.style.display = 'none';
      locationInfoElement.style.display = 'none';
      mapDivElement.style.display = 'none';
      placesListElement.innerHTML = '';
      statusElement.textContent = 'ƒêang x√°c ƒë·ªãnh v·ªã tr√≠...';
      if (map) {
        map.eachLayer(layer => map.removeLayer(layer));
        map.remove();
        map = null;
      }
      if (routingControl) {
        routingControl.spliceWaypoints(0, 2);
        routingControl = null;
      }
    }

    function toggleDarkMode() {
      document.body.classList.add('transitioning');

      setTimeout(() => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        document.getElementById('darkmode-toggle').textContent =
          document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
      }, 50);

      setTimeout(() => {
        document.body.classList.remove('transitioning');
      }, 350);
    }

    window.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
        document.body.classList.add('dark-mode');
        document.getElementById('darkmode-toggle').textContent = '‚òÄÔ∏è';
      }
    });
  </script>
</body>
</html>
